<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤§å­¦ä¸€ç‚¹é€š ProWatermark ä¸“ä¸šæ°´å°å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .author {
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
        }
        .config-section {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .folder-instruction {
            color: #6c757d;
            font-size: 0.9em;
            margin: 10px 0 20px;
            padding-left: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 18px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        input[type="range"] {
            width: 200px;
            margin: 0 10px;
            vertical-align: middle;
        }
        #preview {
            border: 2px solid #dee2e6;
            max-width: 400px;
            margin-top: 15px;
            border-radius: 4px;
        }
        #progress {
            margin-top: 20px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            min-height: 60px;
            max-height: 200px;
            overflow-y: auto;
        }
        .color-danger { color: #dc3545; }
        .right-click-tip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            pointer-events: none; /* é˜²æ­¢æç¤ºæ¡†å½±å“é¼ æ ‡äº‹ä»¶ */
        }
       .right-click-tip.show {
            opacity: 1;
        }
    </style>
    <script>
        document.addEventListener('contextmenu', function (e) {
            e.preventDefault();
            const tip = document.getElementById('right-click-tip');
            tip.style.left = e.pageX + 'px';
            tip.style.top = e.pageY + 'px';
            tip.classList.add('show');

            clearTimeout(tip.timer);
            tip.timer = setTimeout(() => {
                tip.classList.remove('show');
            }, 1500);
        });

        document.addEventListener('copy', function (e) {
            e.preventDefault();
            alert('You cannot copy content of this page');
        });

        document.addEventListener('click', function (e) {
            const tip = document.getElementById('right-click-tip');
            if (!tip.contains(e.target)) {
                clearTimeout(tip.timer);
                tip.classList.remove('show');
            }
        });
    </script>
</head>
<body>
    <div class="header">
        <h1>å›¾ç‰‡æ°´å°æ‰¹é‡å¤„ç†å·¥å…·</h1>
        <div class="author">ç”±ã€Œå¤§å­¦ä¸€ç‚¹é€šã€å›¢é˜Ÿå¼€å‘</div>
<div class="author">æ›´å¤šä¿¡æ¯ï¼Œæ¬¢è¿å…³æ³¨â€œå¤§å­¦ä¸€ç‚¹é€šâ€å…¬ä¼—å·</div>
    </div>

    <div class="config-section">
        <h2>1. æ–‡ä»¶å¤¹è®¾ç½®</h2>
        <div class="folder-instruction">
            æ“ä½œæ­¥éª¤ï¼š<br>
            1. ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ æ–‡ä»¶å¤¹å¯¹<br>
            2. å…ˆé€‰æ‹©è¾“å…¥æ–‡ä»¶å¤¹ï¼Œå†é€‰æ‹©å¯¹åº”çš„è¾“å‡ºæ–‡ä»¶å¤¹<br>
            3. å¯æ·»åŠ å¤šç»„æ–‡ä»¶å¤¹å¯¹è¿›è¡Œæ‰¹é‡å¤„ç†
        </div>
        <div id="folderPairs">
            <button onclick="addFolderPair()">â• æ·»åŠ æ–‡ä»¶å¤¹å¯¹</button>
        </div>
    </div>

    <div class="config-section">
        <h2>2. æ°´å°è®¾ç½®</h2>
        <div style="margin:15px 0">
            <label>ğŸ”– æ°´å°å›¾ç‰‡ï¼š</label>
            <input type="file" id="watermarkFile" accept="image/*">
        </div>
        <div style="margin:15px 0">
            <label>ğŸš ä¸é€æ˜åº¦ï¼š</label>
            <input type="range" id="opacity" min="0" max="1" step="0.01" value="0.5">
            <span id="opacityValue">50%</span>
        </div>
        <div style="margin:15px 0">
            <label>ğŸ“ æ°´å°å¤§å°ï¼š</label>
            <input type="range" id="watermarkScale" min="0.1" max="5" step="0.01" value="1">
            <span id="scaleValue">100%</span>
        </div>
        <div style="margin:15px 0">
            <label>ğŸ“ æ°´å°ä½ç½®ï¼š</label>
            <select id="watermarkPosition">
                <option value="center">å±…ä¸­</option>
                <option value="top-left">å·¦ä¸Š</option>
                <option value="top-right">å³ä¸Š</option>
                <option value="bottom-left">å·¦ä¸‹</option>
                <option value="bottom-right">å³ä¸‹</option>
            </select>
        </div>
    </div>

    <div class="config-section">
        <h2>3. æ•ˆæœé¢„è§ˆ</h2>
        <div style="color:#666; font-size:0.9em; margin:5px 0 15px">
            â€» è‡ªåŠ¨æ˜¾ç¤ºç¬¬ä¸€ä¸ªè¾“å…¥æ–‡ä»¶å¤¹çš„é¦–å¼ å›¾ç‰‡
        </div>
        <canvas id="preview"></canvas>
    </div>

    <div style="text-align: center; margin: 30px 0">
        <button onclick="startProcessing()" style="padding:12px 30px;font-size:1.1em">
            ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†
        </button>
        <div id="progress"></div>
    </div>

    <script>
        let folderPairs = [];
        let watermarkImage = null;
        let previewImage = null;

        async function addFolderPair() {
            try {
                const inputHandle = await window.showDirectoryPicker();
                const outputHandle = await window.showDirectoryPicker();
                
                const pair = { input: inputHandle, output: outputHandle };
                folderPairs.push(pair);
                updateFolderDisplay();

                if (folderPairs.length === 1) {
                    await loadFirstPreviewImage(pair.input);
                }
            } catch (err) {
                console.log('ç”¨æˆ·å–æ¶ˆé€‰æ‹©');
            }
        }

        async function loadFirstPreviewImage(dirHandle) {
            try {
                const files = [];
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file' && isImage(entry.name)) {
                        files.push(entry);
                    }
                }
                if (files.length > 0) {
                    files.sort((a, b) => a.name.localeCompare(b.name));
                    const firstFile = await files[0].getFile();
                    previewImage = await createImageBitmap(firstFile);
                    updatePreview();
                    logProgress(`å·²è‡ªåŠ¨åŠ è½½é¢„è§ˆå›¾ï¼š${files[0].name}`);
                }
            } catch (err) {
                logProgress('âš ï¸ è‡ªåŠ¨é¢„è§ˆå¤±è´¥ï¼Œè¯·ç¡®ä¿ç›®å½•ä¸­æœ‰å›¾ç‰‡æ–‡ä»¶', true);
            }
        }

        function updateFolderDisplay() {
            const container = document.getElementById('folderPairs');
            container.innerHTML = `
                <button onclick="addFolderPair()">â• æ·»åŠ æ–‡ä»¶å¤¹å¯¹</button>
                ${folderPairs.map((pair, index) => `
                    <div style="margin:10px 0; padding:10px; background:#fff; border-radius:4px">
                        ğŸ“‚ è¾“å…¥ï¼š${pair.input.name}<br>
                        ğŸ“ è¾“å‡ºï¼š${pair.output.name}
                        <button onclick="removeFolderPair(${index})">ğŸ—‘ åˆ é™¤</button>
                    </div>
                `).join('')}
            `;
        }

        function removeFolderPair(index) {
            folderPairs.splice(index, 1);
            updateFolderDisplay();
        }

        document.getElementById('watermarkFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (event) => {
                watermarkImage = new Image();
                watermarkImage.onload = () => {
                    const maxSize = 800;
                    if (watermarkImage.width > maxSize || watermarkImage.height > maxSize) {
                        const scale = Math.min(
                            maxSize / watermarkImage.width,
                            maxSize / watermarkImage.height
                        );
                        watermarkImage.width *= scale;
                        watermarkImage.height *= scale;
                    }
                    updatePreview();
                };
                watermarkImage.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        function updatePreview() {
            if (!watermarkImage || !previewImage) return;

            const canvas = document.getElementById('preview');
            const ctx = canvas.getContext('2d');
            canvas.width = previewImage.width;
            canvas.height = previewImage.height;
            
            ctx.drawImage(previewImage, 0, 0);
            
            const scale = parseFloat(document.getElementById('watermarkScale').value);
            const opacity = parseFloat(document.getElementById('opacity').value);
            const width = watermarkImage.width * scale;
            const height = watermarkImage.height * scale;
            const [x, y] = calculatePosition(canvas.width, canvas.height, width, height);
            
            ctx.globalAlpha = opacity;
            ctx.drawImage(watermarkImage, x, y, width, height);
            ctx.globalAlpha = 1.0;
        }

        function calculatePosition(imgW, imgH, wmW, wmH) {
            const padding = 20;
            const pos = document.getElementById('watermarkPosition').value;
            switch(pos) {
                case 'top-left': return [padding, padding];
                case 'top-right': return [imgW - wmW - padding, padding];
                case 'bottom-left': return [padding, imgH - wmH - padding];
                case 'bottom-right': return [imgW - wmW - padding, imgH - wmH - padding];
                default: return [(imgW - wmW)/2, (imgH - wmH)/2];
            }
        }

        async function startProcessing() {
            if (!watermarkImage) {
                alert('è¯·å…ˆé€‰æ‹©æ°´å°å›¾ç‰‡');
                return;
            }
            if (folderPairs.length === 0) {
                alert('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ–‡ä»¶å¤¹å¯¹');
                return;
            }

            const opacity = document.getElementById('opacity').value;
            const scale = document.getElementById('watermarkScale').value;

            for (const pair of folderPairs) {
                await processFolder(pair, opacity, scale);
            }
            logProgress('âœ… å…¨éƒ¨å¤„ç†å®Œæˆï¼');
        }

        async function processFolder(pair, opacity, scale) {
            try {
                for await (const entry of pair.input.values()) {
                    if (entry.kind === 'file' && isImage(entry.name)) {
                        await processFile(entry, pair.output, opacity, scale);
                    }
                }
            } catch (err) {
                logProgress(`âŒ å¤„ç†å¤±è´¥ï¼š${pair.input.name}`, true);
            }
        }

        async function processFile(fileHandle, outputHandle, opacity, scale) {
            try {
                const file = await fileHandle.getFile();
                const img = await createImageBitmap(file);
                
                const canvas = new OffscreenCanvas(img.width, img.height);
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                
                const wmWidth = watermarkImage.width * scale;
                const wmHeight = watermarkImage.height * scale;
                const [x, y] = calculatePosition(canvas.width, canvas.height, wmWidth, wmHeight);
                ctx.globalAlpha = opacity;
                ctx.drawImage(watermarkImage, x, y, wmWidth, wmHeight);
                
                const type = file.type.startsWith('image/') ? file.type : 'image/jpeg';
                const blob = await canvas.convertToBlob({ type });
                
                const newFile = await outputHandle.getFileHandle(fileHandle.name, { create: true });
                const writer = await newFile.createWritable();
                await writer.write(blob);
                await writer.close();
                
                logProgress(`âœ” å·²å¤„ç†ï¼š${fileHandle.name}`);
            } catch (err) {
                logProgress(`âŒ å¤„ç†å¤±è´¥ï¼š${fileHandle.name}`, true);
            }
        }

        function isImage(filename) {
            return /\.(png|jpe?g|webp)$/i.test(filename);
        }

        function logProgress(text, isError = false) {
            const progress = document.getElementById('progress');
            const msg = document.createElement('div');
            msg.textContent = text;
            if (isError) msg.className = 'color-danger';
            progress.appendChild(msg);
            progress.scrollTop = progress.scrollHeight;
        }

        document.getElementById('opacity').addEventListener('input', function() {
            document.getElementById('opacityValue').textContent = 
                Math.round(this.value * 100) + '%';
            updatePreview();
        });

        document.getElementById('watermarkScale').addEventListener('input', function() {
            document.getElementById('scaleValue').textContent = 
                Math.round(this.value * 100) + '%';
            updatePreview();
        });

        document.getElementById('watermarkPosition').addEventListener('change', updatePreview);
    </script>
     <div id="right-click-tip" class="right-click-tip">You cannot copy content of this page</div>
</body>
</html>
